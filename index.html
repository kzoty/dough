<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Calculadoras — Abas</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <meta name="theme-color" content="#111827">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f172a;
      --muted:#8aa0c7;
      --fg:#e5ecff;
      --accent:#7c9cff;
      --accent-2:#22d3ee;
      --border:#1f2a44;
      --ok:#10b981;
      --warn:#f59e0b;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -10%, #16213e 0%, #0b1020 60%);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;color:var(--fg);-webkit-font-smoothing:antialiased;letter-spacing:.2px}
    .wrap{max-width:720px;margin:0 auto;padding:14px}

    header{display:flex;align-items:center;justify-content:space-between;margin:10px 0 6px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:42px;height:42px;border-radius:12px;box-shadow:var(--shadow)}
    h1{font-size:1.05rem;margin:0}
    .subtitle{color:var(--muted);font-size:.86rem}

    .tabs-nav{position:sticky;top:0;z-index:10;display:flex;gap:8px;background:transparent;padding:6px 0 2px 0}
    .tab-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:999px;border:1px solid var(--border);background:rgba(12,18,30,.4);color:var(--fg);font-weight:800;cursor:pointer;backdrop-filter: blur(6px)}
    .tab-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1020;border-color:transparent;box-shadow:0 10px 28px rgba(124,156,255,.28)}

    .panel{display:none}
    .panel.active{display:block}

    .card{background:linear-gradient(180deg, rgba(17,24,39,.88), rgba(15,23,42,.92));border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-top:12px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px}
    .col{flex:1}

    label{display:flex;flex-direction:column;gap:8px;font-size:.9rem}
    input[type=number],input[type=text]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1224;color:var(--fg);font-weight:700}
    .hint{color:var(--muted);font-size:.8rem}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid var(--border);font-weight:800}

    textarea{width:100%;min-height:160px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b0f19;color:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1224;color:var(--fg);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071426;border:0}
    .btn.ghost{background:transparent}

    @media(min-width:560px){
      .wrap{padding:20px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="icon-192.png" alt="Dough">
        <div>
          <h1>Calculadoras</h1>
          <div class="subtitle">Sistema de abas para uso Mobile</div>
        </div>
      </div>
      <button class="btn ghost" id="installBtn" hidden>Instalar</button>
    </header>

    <!-- Navegação de abas -->
    <nav class="tabs-nav" role="tablist" aria-label="Calculadoras">
      <button class="tab-btn active" id="tabMassaBase" role="tab" aria-selected="true" aria-controls="panelMassaBase">Num Massas</button>
      <button class="tab-btn" id="tabNumMassas" role="tab" aria-selected="false" aria-controls="panelNumMassas">Massa Base</button>
      <button class="tab-btn" id="tabPizzas" role="tab" aria-selected="false" aria-controls="panelPizzas">Pizzas</button>
    </nav>

    <!-- Painel 1: Num Massas -->
    <section class="panel" id="panelNumMassas" role="tabpanel" aria-labelledby="tabNumMassas">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>
              <span>Nº de massas <span class="hint">(350 g cada)</span></span>
              <input id="nm-nMassas" type="number" min="1" value="5">
            </label>
          </div>
          <div class="col">
            <label>
              <span>Poolish <span class="hint">(% da farinha)</span></span>
              <input id="nm-poolishPct" type="number" min="10" max="80" step="1" value="30">
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>
              <span>Hidratação <span class="hint">(% água / farinha)</span></span>
              <input id="nm-aguaPct" type="number" min="40" max="90" step="0.5" value="62">
            </label>
          </div>
          <div class="col">
            <label>
              <span>Sal <span class="hint">(% / farinha)</span></span>
              <input id="nm-salPct" type="number" min="0.5" max="3" step="0.1" value="1.5">
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>
              <span>Fermento <span class="hint">(% / farinha)</span></span>
              <input id="nm-fermentoPct" type="number" min="0" max="2" step="0.05" value="0.3">
            </label>
          </div>
          <div class="col">
            <label>
              <span>Temperatura <span class="hint">(°C)</span></span>
              <input id="nm-tempC" type="number" min="0" max="40" step="0.5" value="26">
            </label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row"><div class="col">Massa total</div><div class="pill" id="nm-massaTotal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Farinha total</div><div class="pill" id="nm-farinhaTotal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Água total</div><div class="pill" id="nm-aguaTotal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Sal total</div><div class="pill" id="nm-salTotal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Fermento total</div><div class="pill" id="nm-fermentoTotal">0 g</div></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Poolish (noite anterior)</h3>
        <div class="row"><div class="col">Farinha</div><div class="pill" id="nm-poolishFarinha">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Água</div><div class="pill" id="nm-poolishAgua">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Fermento</div><div class="pill" id="nm-poolishFermento">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Peso do poolish</div><div class="pill" id="nm-poolishPeso">0 g</div></div>
        <p class="hint" id="nm-poolishInstr" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Finalização (manhã)</h3>
        <div class="row"><div class="col">Farinha restante</div><div class="pill" id="nm-finFarinha">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Água restante</div><div class="pill" id="nm-finAgua">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Sal</div><div class="pill" id="nm-finSal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Fermento restante</div><div class="pill" id="nm-finFermento">0 g</div></div>
      </div>

      <div class="card" style="background:#0b0f19;border:1px solid #111827">
        <h3 style="margin:0 0 8px 0">Resumo</h3>
        <textarea id="nm-resumo" readonly></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn primary" id="nm-copy">Copiar resumo</button>
          <span class="hint" id="nm-copyStatus"></span>
        </div>
      </div>
    </section>

    <!-- Painel 2: Massa Base -->
    <section class="panel active" id="panelMassaBase" role="tabpanel" aria-labelledby="tabMassaBase">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h3 style="margin:0">Massa Base</h3>
          <div style="display:flex;gap:8px">
            <button class="btn" id="mb-add">Adicionar</button>
            <button class="btn" id="mb-import">Importar JSON</button>
            <button class="btn" id="mb-export">Exportar JSON</button>
            <input id="mb-importFile" type="file" accept="application/json" style="display:none">
          </div>
        </div>
      </div>

      <div class="card">
        <div id="mb-list" aria-live="polite"></div>
      </div>

      <div class="card">
        <div class="row"><div class="col">Total</div><div class="pill" id="mb-total">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Nº massas <span class="hint">(350 g)</span></div><div class="pill" id="mb-batches">0</div></div>
      </div>

      <div class="card" style="background:#0b0f19;border:1px solid #111827">
        <h3 style="margin:0 0 8px 0">Lista de produtos selecionados</h3>
        <textarea id="mb-selected" readonly></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn primary" id="mb-copy">Copiar lista</button>
          <span class="hint" id="mb-copyStatus"></span>
        </div>
      </div>
    </section>

    <!-- Painel 3: Pizzas -->
    <section class="panel" id="panelPizzas" role="tabpanel" aria-labelledby="tabPizzas">
      <div class="card">
        <div class="row">
          <div class="col">
            <label><span>Nº de pizzas</span><input id="pz-n" type="number" min="1" value="4"></label>
          </div>
          <div class="col">
            <label><span>Peso por bola (g)</span><input id="pz-bola" type="number" min="150" value="250"></label>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label><span>Hidratação final (%)</span><input id="pz-hidrFinal" type="number" min="40" max="90" step="0.5" value="60"></label>
          </div>
          <div class="col">
            <label><span>% da BIGA (%)</span><input id="pz-pctBiga" type="number" min="10" max="90" step="1" value="50"></label>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label><span>Temperatura da BIGA (°C)</span><input id="pz-temp" type="number" min="10" max="35" step="0.5" value="24"></label>
          </div>
          <div class="col">
            <label><span>Tempo da BIGA (h)</span><input id="pz-tempo" type="number" min="4" max="36" step="0.5" value="8"></label>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label><span>Sal (%)</span><input id="pz-sal" type="number" min="1" max="3.5" step="0.1" value="2.5"></label>
          </div>
          <div class="col">
            <label><span>Hidratação da BIGA (%)</span><input id="pz-hidrBiga" type="number" min="40" max="60" step="0.5" value="45"></label>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Totais</h3>
        <div class="row"><div class="col">Peso total da massa</div><div class="pill" id="pz-totalMassa">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Farinha total</div><div class="pill" id="pz-farTotal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Água total</div><div class="pill" id="pz-aguaTotal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Sal total</div><div class="pill" id="pz-salTotal">0 g</div></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">BIGA</h3>
        <div class="row"><div class="col">Farinha BIGA</div><div class="pill" id="pz-farBiga">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Água BIGA</div><div class="pill" id="pz-aguaBiga">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Fermento BIGA</div><div class="pill" id="pz-ferBiga">0 g</div></div>
        <p class="hint" id="pz-bigaInstr" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Massa Final</h3>
        <div class="row"><div class="col">Farinha (restante)</div><div class="pill" id="pz-farFinal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Água (restante)</div><div class="pill" id="pz-aguaFinal">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Sal (total)</div><div class="pill" id="pz-salOut">0 g</div></div>
        <div class="row" style="margin-top:6px"><div class="col">Fermento adicional</div><div class="pill">0 g</div></div>
      </div>

      <div class="card" style="background:#0b0f19;border:1px solid #111827">
        <h3 style="margin:0 0 8px 0">Resumo</h3>
        <textarea id="pz-resumo" readonly></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn primary" id="pz-copy">Copiar resumo</button>
          <span class="hint" id="pz-copyStatus"></span>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Validações</h3>
        <div class="hint" id="pz-warnings"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Ponto ideal da BIGA</h3>
        <p class="hint">A biga estará pronta quando apresentar estrutura quebradiça, aroma levemente adocicado/lácteo, sem colapso ou odor alcoólico forte.</p>
      </div>
    </section>
  </div>

  <script>
    // PWA: registrar service worker e lidar com instalação
    (function(){
      const statusEl = document.getElementById('status');
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
          console.log('Service worker registered', reg);
          if(statusEl) statusEl.textContent = 'Service worker registered.';
        }).catch(err => {
          console.warn('SW registration failed', err);
          if(statusEl) statusEl.textContent = 'Service worker registration failed.';
        });
      }
      let deferredPrompt;
      const installBtn = document.getElementById('installBtn');
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(installBtn) installBtn.hidden = false;
      });
      if(installBtn){
        installBtn.addEventListener('click', async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          try{ await deferredPrompt.userChoice; }catch(e){}
          deferredPrompt = null;
          installBtn.hidden = true;
        });
      }
    })();
    // Tabs
    (function(){
      const TAB_KEY = 'tab_active_calc_v1';
      const tabs = [
        {btn: document.getElementById('tabMassaBase'), panel: document.getElementById('panelMassaBase'), id: 'base'},
        {btn: document.getElementById('tabNumMassas'), panel: document.getElementById('panelNumMassas'), id: 'num'},
        {btn: document.getElementById('tabPizzas'), panel: document.getElementById('panelPizzas'), id: 'pizzas'}
      ];
      function activate(id){
        tabs.forEach(t => {
          const active = t.id === id;
          t.btn.classList.toggle('active', active);
          t.btn.setAttribute('aria-selected', String(active));
          t.panel.classList.toggle('active', active);
        });
        try{ localStorage.setItem(TAB_KEY, id); }catch(e){}
      }
      tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.id)));
      let last = null; try{ last = localStorage.getItem(TAB_KEY);}catch(e){}
      activate(['num','pizzas'].includes(last) ? last : 'base');
    })();

    // Helpers
    const fmt = n => `${Math.round(n*10)/10}g`;

    // Calculadora Num Massas (baseada na lógica atual)
    (function(){
      const SKEY = 'tab_calc_nm_v1';
      const el = id => document.getElementById(id);
      const nM = el('nm-nMassas');
      const pPct = el('nm-poolishPct');
      const hPct = el('nm-aguaPct');
      const sPct = el('nm-salPct');
      const yPct = el('nm-fermentoPct');
      const tC = el('nm-tempC');

      const massaTotal = el('nm-massaTotal');
      const farinhaTotal = el('nm-farinhaTotal');
      const aguaTotal = el('nm-aguaTotal');
      const salTotal = el('nm-salTotal');
      const fermTotal = el('nm-fermentoTotal');

      const pFar = el('nm-poolishFarinha');
      const pAgua = el('nm-poolishAgua');
      const pFer = el('nm-poolishFermento');
      const pPeso = el('nm-poolishPeso');
      const pInstr = el('nm-poolishInstr');

      const fFar = el('nm-finFarinha');
      const fAgua = el('nm-finAgua');
      const fSal = el('nm-finSal');
      const fFer = el('nm-finFermento');

      const resumo = el('nm-resumo');
      const copyBtn = el('nm-copy');
      const copyStatus = el('nm-copyStatus');

      function load(){
        try{ const raw = localStorage.getItem(SKEY); if(!raw) return; const s = JSON.parse(raw);
          if(s.nM!=null) nM.value = s.nM; if(s.pPct!=null) pPct.value = s.pPct; if(s.hPct!=null) hPct.value = s.hPct; if(s.sPct!=null) sPct.value = s.sPct; if(s.yPct!=null) yPct.value = s.yPct; if(s.tC!=null) tC.value = s.tC;
        }catch(e){}
      }
      function save(){
        try{ localStorage.setItem(SKEY, JSON.stringify({nM:nM.value,pPct:pPct.value,hPct:hPct.value,sPct:sPct.value,yPct:yPct.value,tC:tC.value})); }catch(e){}
      }

      function recalc(){
        const n = Math.max(1, parseInt(nM.value||'0'));
        const massTot = n*350;
        const h = Math.max(0, parseFloat(hPct.value||'62'))/100;
        const s = Math.max(0, parseFloat(sPct.value||'1.5'))/100;
        const y = Math.max(0, parseFloat(yPct.value||'0.3'))/100;
        const pool = Math.max(0, Math.min(0.8, parseFloat(pPct.value||'30')/100));
        const temp = parseFloat(tC.value||'25');

        const farTot = massTot / (1 + h + s + y);
        const aguTot = farTot * h;
        const salTot = farTot * s;
        const ferTot = farTot * y;

        const pFarinha = farTot * pool;
        const pAg = pFarinha;
        let yPool = 0.001; // fallback
        if (temp >= 18 && temp <= 20) yPool = 0.0013; else if (temp > 20 && temp <= 24) yPool = 0.0010; else if (temp > 24 && temp <= 28) yPool = 0.0006;
        const pFermento = pFarinha * yPool;

        const pf = Math.min(pFarinha, farTot);
        const pa = Math.min(pAg, aguTot);
        const py = Math.min(pFermento, ferTot);

        const finFar = Math.max(0, farTot - pf);
        const finAgu = Math.max(0, aguTot - pa);
        const finSal = salTot;
        const finFer = Math.max(0, ferTot - py);

        massaTotal.textContent = fmt(massTot);
        farinhaTotal.textContent = fmt(farTot);
        aguaTotal.textContent = fmt(aguTot);
        salTotal.textContent = fmt(salTot);
        fermTotal.textContent = fmt(ferTot);

        pFar.textContent = fmt(pf);
        pAgua.textContent = fmt(pa);
        pFer.textContent = fmt(py);
        pPeso.textContent = fmt(pf+pa+py);
        pInstr.textContent = `Na noite anterior: misture ${fmt(pf)} de farinha, ${fmt(pa)} de água e ${fmt(py)} de fermento. Deixe fermentar 8–12h.`;

        fFar.textContent = fmt(finFar);
        fAgua.textContent = fmt(finAgu);
        fSal.textContent = fmt(finSal);
        fFer.textContent = fmt(finFer);

        const hid = Math.round(h*1000)/10, salp = Math.round(s*1000)/10, poolp = Math.round(pool*1000)/10, tempStr = isNaN(temp)?'-':Math.round(temp);
        const lines = [
          `--- ${n} MASSAS ---`,
          `hidratação ${hid} | poolish ${poolp} | sal ${salp} | temp ${tempStr}`,
          '',
          'Poolish',
          `* FAR: ${Math.round(pf*10)/10}g`,
          `* H2O: ${Math.round(pa*10)/10}g`,
          `* FER: ${Math.round(py*10)/10}g`,
          '',
          'FINALIZAÇÃO',
          `* FAR: ${Math.round(finFar*10)/10}g`,
          `* H2O: ${Math.round(finAgu*10)/10}g`,
          `* SAL: ${Math.round(finSal*10)/10}g`,
          `* FER: ${Math.round(finFer*10)/10}g`,
        ];
        resumo.value = lines.join('\n');
        save();
      }

      [nM,pPct,hPct,sPct,yPct,tC].forEach(i=>{ i.addEventListener('input', recalc); i.addEventListener('change', recalc); });
      if (copyBtn) copyBtn.addEventListener('click', async () => {
        try{ await navigator.clipboard.writeText(resumo.value); copyStatus.textContent = 'Copiado!'; setTimeout(()=>copyStatus.textContent='',2000);}catch(e){ copyStatus.textContent = 'Falha ao copiar'; }
      });

      load();
      recalc();
    })();

    // --- Massa Base (produtos) ---
    (function(){
      const PRODUCTS_URL = 'products.json';
      const STORAGE_KEY = 'tab_mb_products_v1';

      const $ = id => document.getElementById(id);
      const listEl = $('mb-list');
      const totalEl = $('mb-total');
      const batchesEl = $('mb-batches');
      const selectedEl = $('mb-selected');
      const copyBtn = $('mb-copy');
      const copyStatus = $('mb-copyStatus');
      const addBtn = $('mb-add');
      const importBtn = $('mb-import');
      const exportBtn = $('mb-export');
      const importFile = $('mb-importFile');

      let products = [];

      const formatG = n => `${Math.round(n)} g`;

      function persist(){
        try{
          const data = products.map(p => ({name:p.name, weight:p.weight, qty:p.qty||0}));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }catch(e){ console.warn('Falha ao salvar MB', e); }
      }

      async function load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            products = JSON.parse(raw);
          } else {
            const res = await fetch(PRODUCTS_URL);
            products = await res.json();
            products = products.map(p => ({...p, qty: p.qty || 0}));
          }
        }catch(e){
          console.warn('Falha ao carregar produtos', e);
          products = [];
        }
        render();
      }

      function createRow(p, idx){
        const row = document.createElement('div');
        row.className = 'card';
        row.style.marginTop = '10px';
        row.style.padding = '10px';

        const top = document.createElement('div');
        top.className = 'row';
        top.style.alignItems = 'center';
        top.style.justifyContent = 'space-between';

        const left = document.createElement('div');
        const title = document.createElement('div');
        title.innerHTML = `<strong>${p.name}</strong>`;
        const sub = document.createElement('div');
        sub.className = 'hint';
        sub.textContent = `${p.weight} g`;
        left.appendChild(title);
        left.appendChild(sub);
        left.addEventListener('dblclick', (e)=>{ e.stopPropagation(); showEdit(idx, row); });

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';

        const btnMinus = document.createElement('button');
        btnMinus.className = 'btn';
        btnMinus.textContent = '−';
        btnMinus.style.width = '44px';
        btnMinus.addEventListener('click', ()=> setQty(idx, (p.qty||0)-1));

        const qty = document.createElement('input');
        qty.type = 'number'; qty.min = '0'; qty.value = p.qty||0;
        qty.style.width = '80px'; qty.style.textAlign = 'center'; qty.style.fontWeight='800';
        qty.addEventListener('change', ()=>{
          const v = Math.max(0, parseInt(qty.value)||0);
          setQty(idx, v);
        });

        const btnPlus = document.createElement('button');
        btnPlus.className = 'btn primary';
        btnPlus.textContent = '+';
        btnPlus.style.width = '44px';
        btnPlus.addEventListener('click', ()=> setQty(idx, (p.qty||0)+1));

        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.style.minWidth = '88px';
        pill.style.textAlign = 'center';
        pill.textContent = formatG((p.qty||0) * p.weight);

        right.appendChild(btnMinus);
        right.appendChild(qty);
        right.appendChild(btnPlus);
        right.appendChild(pill);

        top.appendChild(left);
        top.appendChild(right);
        row.appendChild(top);
        return {row, qty, pill};
      }

      function showEdit(idx, container){
        if(container._edit){ return; }
        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.style.marginTop = '8px';
        wrap.style.padding = '10px';
        wrap.style.background = '#0b1224';

        const name = document.createElement('input'); name.type='text'; name.value=products[idx].name; name.placeholder='Nome';
        const weight = document.createElement('input'); weight.type='number'; weight.value=products[idx].weight; weight.placeholder='Peso (g)'; weight.style.marginTop='8px';

        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
        const save = document.createElement('button'); save.className='btn primary'; save.textContent='Salvar';
        const del = document.createElement('button'); del.className='btn'; del.textContent='Excluir';

        save.addEventListener('click', ()=>{
          const newName = (name.value||'').trim() || products[idx].name;
          const newW = Math.max(0, parseInt(weight.value)||products[idx].weight);
          products[idx].name = newName; products[idx].weight = newW;
          persist(); render();
        });
        del.addEventListener('click', ()=>{
          if(!confirm('Excluir este produto?')) return;
          products.splice(idx,1); persist(); render();
        });

        actions.appendChild(save); actions.appendChild(del);
        wrap.appendChild(name); wrap.appendChild(weight); wrap.appendChild(actions);
        container.appendChild(wrap);
        container._edit = wrap;
      }

      function render(){
        listEl.innerHTML='';
        const rows = [];
        products.forEach((p,i)=>{
          const {row, qty, pill} = createRow(p,i);
          row._qty = qty; row._pill = pill;
          listEl.appendChild(row);
          rows.push(row);
        });
        updateSummary();
      }

      function setQty(idx, v){
        if(v<0) v=0;
        products[idx].qty = v;
        // update UI
        const row = listEl.children[idx];
        if(row){
          row._qty.value = v;
          row._pill.textContent = formatG(v * products[idx].weight);
        }
        updateSummary();
        persist();
      }

      function updateSummary(){
        const total = products.reduce((s,p)=> s + (p.weight * (p.qty||0)), 0);
        totalEl.textContent = formatG(total);
        const batches = Math.ceil(total / 350) || 0;
        batchesEl.textContent = `${batches}`;

        const lines = products.filter(p=> (p.qty||0)>0).map(p=> `${p.name} - ${p.qty}`);
        selectedEl.value = lines.join('\n');
      }

      // actions
      if(copyBtn) copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(selectedEl.value); copyStatus.textContent='Copiado!'; setTimeout(()=>copyStatus.textContent='', 1800);}catch(e){ copyStatus.textContent='Falha ao copiar'; }
      });

      if(addBtn) addBtn.addEventListener('click', ()=>{
        // quick add inline
        const quick = document.createElement('div');
        quick.className = 'card'; quick.style.marginTop='8px'; quick.style.padding='10px';
        const name = document.createElement('input'); name.type='text'; name.placeholder='Nome do produto';
        const weight = document.createElement('input'); weight.type='number'; weight.placeholder='Peso (g)'; weight.style.marginTop='8px';
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
        const save = document.createElement('button'); save.className='btn primary'; save.textContent='Salvar';
        const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancelar';
        actions.appendChild(save); actions.appendChild(cancel);
        quick.appendChild(name); quick.appendChild(weight); quick.appendChild(actions);
        // insert at top
        if(listEl.firstChild) listEl.insertBefore(quick, listEl.firstChild); else listEl.appendChild(quick);
        name.focus();
        save.addEventListener('click', ()=>{
          const nm = (name.value||'').trim(); const w = Math.max(0, parseInt(weight.value)||0);
          if(!nm || w<=0){ alert('Informe nome e peso válidos'); return; }
          products.push({name:nm, weight:w, qty:0}); persist(); render();
        });
        cancel.addEventListener('click', ()=> quick.remove());
      });

      if(exportBtn) exportBtn.addEventListener('click', ()=>{
        const data = JSON.stringify(products.map(p=>({name:p.name,weight:p.weight})), null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href=url; a.download='products-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      if(importBtn) importBtn.addEventListener('click', ()=> importFile && importFile.click());
      if(importFile) importFile.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const data = JSON.parse(reader.result);
            if(!Array.isArray(data)) throw new Error('Formato inválido');
            products = data.map(d=>({name: d.name || 'Produto', weight: parseInt(d.weight)||0, qty:0}));
            persist(); render();
          }catch(err){ alert('Arquivo inválido: '+ err.message); }
        };
        reader.readAsText(f);
        importFile.value = '';
      });

      load();
    })();

    // --- Pizzas (BIGA) ---
    (function(){
      const SKEY = 'tab_calc_pizzas_v1';
      const $ = id => document.getElementById(id);
      // inputs
      const n=$('pz-n'), bola=$('pz-bola'), hidrFinal=$('pz-hidrFinal'), pctBiga=$('pz-pctBiga'), temp=$('pz-temp'), tempo=$('pz-tempo'), sal=$('pz-sal'), hidrBiga=$('pz-hidrBiga');
      // outputs
      const totalMassa=$('pz-totalMassa'), farTotal=$('pz-farTotal'), aguaTotal=$('pz-aguaTotal'), salTotal=$('pz-salTotal');
      const farBiga=$('pz-farBiga'), aguaBiga=$('pz-aguaBiga'), ferBiga=$('pz-ferBiga'), bigaInstr=$('pz-bigaInstr');
      const farFinal=$('pz-farFinal'), aguaFinal=$('pz-aguaFinal'), salOut=$('pz-salOut');
      const resumo=$('pz-resumo'), copyBtn=$('pz-copy'), copyStatus=$('pz-copyStatus'), warnings=$('pz-warnings');

      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

      function recalc(){
        const N = Math.max(1, parseInt(n.value||'0'));
        const PB = Math.max(1, parseFloat(bola.value||'0'));
        const HF = Math.max(0, parseFloat(hidrFinal.value||'60'))/100; // fração
        const PCTB = Math.max(0, parseFloat(pctBiga.value||'50'))/100; // fração
        const T = parseFloat(temp.value||'24');
        const H = Math.max(1, parseFloat(tempo.value||'8'));
        const SAL = Math.max(0, parseFloat(sal.value||'2.5'))/100; // fração
        const HB = Math.max(0, parseFloat(hidrBiga.value||'45'))/100; // fração

        const pesoTot = N * PB;
        const farinhaTot = pesoTot / (1 + HF + SAL);
        const aguaTot = farinhaTot * HF;
        const salTot = farinhaTot * SAL;

        const fBiga = farinhaTot * PCTB;
        const fFinal = farinhaTot - fBiga;
        const aBiga = fBiga * HB;
        const aFinal = Math.max(0, aguaTot - aBiga);

        const fermentoBase = 0.22/100; // 0,22%
        let fatorTemp = 1.0;
        if (T <= 20) fatorTemp = 1.15; else if (T <= 22) fatorTemp = 1.05; else if (T <= 24) fatorTemp = 1.00; else if (T <= 26) fatorTemp = 0.90; else fatorTemp = 0.80;
        const fatorTempo = clamp(8 / H, 0.7, 1.3);
        const fermPctFinal = fermentoBase * fatorTemp * fatorTempo; // fração
        const fBigaFer = fBiga * fermPctFinal;

        // set outputs
        totalMassa.textContent = fmt(pesoTot);
        farTotal.textContent = fmt(farinhaTot);
        aguaTotal.textContent = fmt(aguaTot);
        salTotal.textContent = fmt(salTot);

        farBiga.textContent = fmt(fBiga);
        aguaBiga.textContent = fmt(aBiga);
        ferBiga.textContent = fmt(fBigaFer);
        farFinal.textContent = fmt(fFinal);
        aguaFinal.textContent = fmt(aFinal);
        salOut.textContent = fmt(salTot);
        bigaInstr.textContent = `Fermentar por ${H} horas a ${Math.round(T)} °C, coberto, sem vedar totalmente.`;

        // warnings
        const ws=[];
        const HFp=HF*100, PCTBp=PCTB*100, HBp=HB*100;
        if (HFp < 55 || HFp > 70) ws.push('Atenção: hidratação final fora do intervalo 55–70%.');
        if (PCTBp < 30 || PCTBp > 70) ws.push('Atenção: percentual de BIGA fora do intervalo 30–70%.');
        if (HBp < 44 || HBp > 50) ws.push('Atenção: hidratação da BIGA fora do intervalo 44–50%.');
        if (T > 28) ws.push('Alerta crítico: temperatura da BIGA acima de 28 °C (risco de colapso).');
        warnings.innerHTML = ws.length ? ws.map(s=>`• ${s}`).join('<br>') : 'Parâmetros dentro dos limites recomendados.';

        // resumo
        const lines = [
          `--- PIZZAS (BIGA) ---`,
          `N=${N} | bola=${PB}g | hidrFinal=${Math.round(HFp*10)/10}% | pctBiga=${Math.round(PCTBp*10)/10}% | sal=${Math.round(SAL*1000)/10}%`,
          `temp=${Math.round(T)}°C | tempo=${H}h | hidrBiga=${Math.round(HBp*10)/10}%`,
          '',
          'BIGA',
          `* FAR: ${Math.round(fBiga*10)/10}g`,
          `* H2O: ${Math.round(aBiga*10)/10}g`,
          `* FER: ${Math.round(fBigaFer*10)/10}g`,
          '',
          'MASSA FINAL',
          `* FAR: ${Math.round(fFinal*10)/10}g`,
          `* H2O: ${Math.round(aFinal*10)/10}g`,
          `* SAL: ${Math.round(salTot*10)/10}g`,
          `* FER: 0g`,
        ];
        resumo.value = lines.join('\n');

        // persist
        try{ localStorage.setItem(SKEY, JSON.stringify({N:n.value,PB:bola.value,HF:hidrFinal.value,PCTB:pctBiga.value,T:temp.value,H:tempo.value,SAL:sal.value,HB:hidrBiga.value})); }catch(e){}
      }

      // load
      (function(){
        try{ const raw = localStorage.getItem(SKEY); if(!raw) return; const s = JSON.parse(raw);
          if(s.N!=null) n.value=s.N; if(s.PB!=null) bola.value=s.PB; if(s.HF!=null) hidrFinal.value=s.HF; if(s.PCTB!=null) pctBiga.value=s.PCTB; if(s.T!=null) temp.value=s.T; if(s.H!=null) tempo.value=s.H; if(s.SAL!=null) sal.value=s.SAL; if(s.HB!=null) hidrBiga.value=s.HB;
        }catch(e){}
      })();

      [n,bola,hidrFinal,pctBiga,temp,tempo,sal,hidrBiga].forEach(i=>{ if(i){ i.addEventListener('input', recalc); i.addEventListener('change', recalc); } });
      if (copyBtn) copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(resumo.value); copyStatus.textContent='Copiado!'; setTimeout(()=>copyStatus.textContent='',1800);}catch(e){ copyStatus.textContent='Falha ao copiar'; } });

      recalc();
    })();
  </script>
</body>
</html>
